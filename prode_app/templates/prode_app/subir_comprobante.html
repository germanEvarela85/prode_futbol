{% extends "prode_app/base.html" %}
{% block content %}

<h1>Subir comprobante de pago</h1>

<div class="card">

    {% if cierre_prode and cierre_prode <= now %}
        <p style="color:red; font-weight:bold;">
            ‚õî El per√≠odo para subir comprobantes para esta fecha ya cerr√≥.
        </p>
    {% else %}
        <p id="contador_comprobante" style="color:red; margin-top:15px; font-weight:bold;"></p>
        <script>
            const cierreComprobante = new Date("{{ cierre_prode|date:'Y-m-d H:i:s' }}").getTime();
            const contadorElemComprobante = document.getElementById('contador_comprobante');
            function actualizarContadorComprobante() {
                const now = new Date().getTime();
                let diff = cierreComprobante - now;
                if(diff <= 0) {
                    contadorElemComprobante.innerText = "‚õî El prode ya cerr√≥";
                    clearInterval(intervaloComprobante);
                    return;
                }
                const h = Math.floor(diff / (1000*60*60));
                const m = Math.floor((diff % (1000*60*60)) / (1000*60));
                const s = Math.floor((diff % (1000*60)) / 1000);
                contadorElemComprobante.innerText =
                    `Tiempo restante para cerrar: ${h}h ${m}m ${s}s`;
            }
            const intervaloComprobante = setInterval(actualizarContadorComprobante, 1000);
            actualizarContadorComprobante();
        </script>
    {% endif %}

    {% for message in messages %}
        <div class="alert success">{{ message }}</div>
    {% endfor %}

    <p><strong>Realiz√° la transferencia a:</strong></p>
    <ul>
        <li><strong>Banco:</strong> {{ cuenta_info.banco }}</li>
        <li><strong>Alias:</strong> {{ cuenta_info.alias }}</li>
        <li><strong>CBU:</strong> {{ cuenta_info.cbu }}</li>
        <li><strong>Titular:</strong> {{ cuenta_info.titular }}</li>
    </ul>

    <p style="margin-top:10px;">
        ‚ö†Ô∏è S√≥lo aparecen tus tarjetas disponibles para seleccionar.
    </p>

    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}

        <label for="id_tarjeta">Seleccion√° tarjeta:</label>
        <select name="tarjeta" id="id_tarjeta" required>
            {% for t in tarjetas_usuario %}
                <option value="{{ t.tarjeta.id }}" {% if t.pagada %}disabled{% endif %}>
                    {{ t.tarjeta.nombre_tarjeta }}
                    {% if t.pagada %} ‚Äî ‚úÖ Comprobante enviado{% endif %}
                </option>
            {% endfor %}
        </select>

        {{ form.archivo.label_tag }}
        {{ form.archivo }}

        {{ form.comentario.label_tag }}
        {{ form.comentario }}

        <div style="margin-top:20px;">
            <button type="submit" class="button">Enviar comprobante</button>
        </div>
    </form>

    <p style="margin-top:15px; color: var(--muted);">
        üì© Una vez enviado, recibir√°s un email de confirmaci√≥n.
    </p>

</div>

{% endblock %}
